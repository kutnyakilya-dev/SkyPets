<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–æ–≤–µ—Ü –ñ–∏–≤–æ—Ç–Ω—ã—Ö</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap');

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            font-family: 'Fredoka', sans-serif;
            color: #333;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        #game-container {
            width: 95%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            background-color: #fff;
            padding: 10px;
            text-align: center;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –∫–Ω–æ–ø–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π */
        #header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0 10px;
            box-sizing: border-box;
            margin-bottom: 5px;
        }

        h1 {
            color: #388e3c;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            margin: 0; /* –£–±—Ä–∞–ª–∏ –≤–µ—Ä—Ö–Ω–∏–π –∏ –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –∏–º–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
            font-size: 1.5rem;
        }

        #canvas {
            display: block;
            background-color: #e0f7fa;
            border: 5px solid #00bcd4;
            border-radius: 15px;
            touch-action: none;
        }

        #info-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            font-size: 1.1rem; 
            font-weight: 700;
        }

        .info-item {
            padding: 5px 10px;
            border-radius: 10px;
            background-color: #ffcc80;
            color: #d84315;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #controls {
            padding: 10px 0;
        }

        /* --- –û–ë–©–ò–ô –°–¢–ò–õ–¨ –î–õ–Ø –í–°–ï–• –ö–ù–û–ü–û–ö --- */
        button {
            border: none;
            padding: 10px 20px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.1s ease;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        button:active {
            /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è: —Ç–µ–Ω—å —É—Ö–æ–¥–∏—Ç, –∫–Ω–æ–ø–∫–∞ –æ–ø—É—Å–∫–∞–µ—Ç—Å—è */
            box-shadow: 0 0 !important; 
            transform: translateY(4px);
        }
        /* --- –ö–û–ù–ï–¶ –û–ë–©–ï–ì–û –°–¢–ò–õ–Ø --- */

        /* --- News Button (–ö–Ω–æ–ø–∫–∞ –ù–æ–≤–æ—Å—Ç–∏) --- */
        #newsButton {
            background: linear-gradient(to top right, #fff 0%, #ffe0b2 100%);
            color: #ff9800;
            border: 2px solid #ff9800;
            padding: 5px 10px;
            font-size: 1.5rem;
            line-height: 1;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px #e65100;
            transition: transform 0.1s ease;
            text-shadow: none; 
            margin-right: -10px; /* –°–¥–≤–∏–≥–∞–µ–º –Ω–µ–º–Ω–æ–≥–æ –≤–ø—Ä–∞–≤–æ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è —Å –∫—Ä–∞–µ–º */
        }
        
        #newsButton:active {
            transform: translateY(2px);
            box-shadow: 0 1px #e65100;
        }
        /* ------------------------------------------------ */

        /* --- START/RESET Button (–ó–µ–ª–µ–Ω–∞—è —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º) --- */
        #startButton {
            color: white;
            background: linear-gradient(to bottom, #66bb6a 0%, #388e3c 100%); /* –ó–µ–ª–µ–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            box-shadow: 0 6px #1b5e20; /* –¢–µ–º–Ω–∞—è –Ω–∏–∂–Ω—è—è —Ç–µ–Ω—å */
            width: 80%;
            max-width: 250px;
            margin-top: 10px;
            font-size: 1.3rem;
        }
        
        #startButton:active {
            box-shadow: 0 0 !important;
        }

        #startButton[disabled] {
            opacity: 0.7;
            cursor: not-allowed;
            box-shadow: 0 0 #1b5e20;
            transform: translateY(4px);
        }
        /* ------------------------------------------------ */


        /* --- Difficulty Buttons (–ö–Ω–æ–ø–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏) --- */
        .difficulty-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px; 
            margin-bottom: 10px;
        }

        .difficulty-buttons button {
            font-size: 1.0rem;
            padding: 8px 10px;
            width: 32%;
            margin: 0;
            color: #333;
            background-color: #e0e0e0; /* –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω */
            box-shadow: 0 3px #bdbdbd; /* –õ–µ–≥–∫–∞—è —Ç–µ–Ω—å */
            text-shadow: none;
            border-radius: 20px;
        }
        
        .difficulty-buttons button:hover:not(.active) {
            background-color: #cccccc;
        }

        /* –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏ */
        #difficulty-relax.active {
            color: white;
            background: linear-gradient(to bottom, #4fc3f7 0%, #039be5 100%); /* –ì–æ–ª—É–±–æ–π (–†–µ–ª–∞–∫—Å) */
            box-shadow: 0 4px #01579b;
        }
        
        #difficulty-farm.active {
            color: white;
            background: linear-gradient(to bottom, #ffb300 0%, #ff8f00 100%); /* –û—Ä–∞–Ω–∂–µ–≤—ã–π (–§–µ—Ä–º–∞) */
            box-shadow: 0 4px #e65100;
        }
        
        #difficulty-hell.active {
            color: white;
            background: linear-gradient(to bottom, #e57373 0%, #c62828 100%); /* –ö—Ä–∞—Å–Ω—ã–π (–ê–¥) */
            box-shadow: 0 4px #b71c1c;
        }
        /* ------------------------------------------------ */


        /* --- Restart button (–Ω–∞ —ç–∫—Ä–∞–Ω–µ Game Over) --- */
        #game-over-screen button {
            background: linear-gradient(to bottom, #ffb300 0%, #f57c00 100%);
            box-shadow: 0 4px #e65100;
        }
        
        #game-over-screen button:active {
            box-shadow: 0 0 #e65100;
        }
        
        /* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ù–û–í–û–°–¢–ï–ô --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-out;
            /* –î–û–ë–ê–í–õ–ï–ù–û –î–õ–Ø –°–ö–†–û–õ–õ–ê */
            max-height: 80vh; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã */
            overflow-y: auto; /* –í–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è */
        }

        .modal-content h2 {
            color: #ff9800;
            margin-top: 0;
            font-size: 1.8rem;
        }
        
        .modal-content h3 {
            color: #388e3c;
            margin-top: 15px;
            font-size: 1.3rem;
        }

        .modal-content p {
            margin: 10px 0;
            color: #555;
            font-size: 1rem;
        }
        
        #closeModalButton {
            margin-top: 20px;
            width: 100%;
            background: linear-gradient(to bottom, #ffb300 0%, #ff8f00 100%); /* –û—Ä–∞–Ω–∂–µ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            box-shadow: 0 4px #e65100;
            color: white;
            font-size: 1.3rem;
            padding: 12px 20px;
        }
        
        #closeModalButton:active {
            box-shadow: 0 0 #e65100 !important;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tone.js –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ –∑–≤—É–∫–æ–º -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
</head>
<body>

<div id="game-container">
    <div id="header-container">
        <h1>–õ–æ–≤–µ—Ü –ñ–∏–≤–æ—Ç–Ω—ã—Ö! üé∂</h1>
        <button id="newsButton" title="–ù–æ–≤–æ—Å—Ç–∏ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏">üì∞</button>
    </div>

    <div id="info-bar">
        <div class="info-item">–°–ß–ï–¢: <span id="score">0</span></div>
        <div class="info-item">–õ–£–ß–®–ò–ô –°–ß–ï–¢: <span id="high-score">0</span></div>
    </div>

    <canvas id="canvas"></canvas>

    <div id="controls">
        <div class="difficulty-buttons" id="difficulty-selection">
            <button id="difficulty-relax" data-level="relax">–†–µ–ª–∞–∫—Å</button>
            <button id="difficulty-farm" data-level="farm">–§–µ—Ä–º–∞</button>
            <button id="difficulty-hell" data-level="hell">–ê–¥</button>
        </div>
        <button id="startButton">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
    </div>

    <div id="game-over-screen">
        <p>–ò–ì–†–ê –°–ë–†–û–®–ï–ù–ê!</p>
        <p>–¢–≤–æ–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç: <span id="final-score">0</span></p>
        <button id="restartButton">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–æ–≤–æ—Å—Ç–µ–π -->
<div id="news-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>üéâ –ù–æ–≤–æ—Å—Ç–∏ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è! üéâ</h2>
        <p>–ü—Ä–∏–≤–µ—Ç, –ò–≥—Ä–æ–∫–∏!</p>
        <p>–ú—ã –ø—Ä–∏—Å–ª—É—à–∞–ª–∏—Å—å –∫ –≤–∞—à–∏–º –ø–æ–∂–µ–ª–∞–Ω–∏—è–º –∏ –≤–Ω–µ—Å–ª–∏ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –±–æ–ª–µ–µ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π –∏–≥—Ä—ã:</p>
        
        <h3>1. –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –ó–æ–Ω–∞ –ü–æ–ø–∞–¥–∞–Ω–∏—è (x2)</h3>
        <p>
            –ú—ã **–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–ª–∏ –Ω–µ–≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å** –¥–ª—è –∫–ª–∏–∫–∞ –≤–æ–∫—Ä—É–≥ –∫–∞–∂–¥–æ–≥–æ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ. –¢–µ–ø–µ—Ä—å –ø–æ–ø–∞–¥–∞—Ç—å –ø–æ –±—ã—Å—Ç—Ä–æ –¥–≤–∏–∂—É—â–∏–º—Å—è –∑–≤–µ—Ä—è–º —Å—Ç–∞–ª–æ –≤ **2 —Ä–∞–∑–∞ –ø—Ä–æ—â–µ**!
        </p>

        <h3>2. –†–µ–∂–∏–º ¬´–§–µ—Ä–º–∞¬ª —Å—Ç–∞–ª –ª–µ–≥—á–µ</h3>
        <p>
            –î–ª—è –±–æ–ª–µ–µ —Ä–∞—Å—Å–ª–∞–±–ª—è—é—â–µ–π –∏–≥—Ä—ã, —Ä–µ–∂–∏–º **¬´–§–µ—Ä–º–∞¬ª** –±—ã–ª —Å–¥–µ–ª–∞–Ω –º—è–≥—á–µ. –ñ–∏–≤–æ—Ç–Ω—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç **–º–µ–¥–ª–µ–Ω–Ω–µ–µ** (—Å–∫–æ—Ä–æ—Å—Ç—å: 0.5) –∏ –Ω–∞–±–∏—Ä–∞—é—Ç —Å–∫–æ—Ä–æ—Å—Ç—å **–Ω–µ —Ç–∞–∫ –±—ã—Å—Ç—Ä–æ** (–ø—Ä–∏—Ä–æ—Å—Ç: 0.03). –û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∂–∏–º, —á—Ç–æ–±—ã –ø–æ–±–∏—Ç—å —Å–≤–æ–π –ª—É—á—à–∏–π —Å—á–µ—Ç!
        </p>
        
        <h3>3. –†–∞–∑–Ω—ã–µ –û—á–∫–∏ –∏ –í—Å–ø–ª—ã–≤–∞—é—â–∏–π –°—á–µ—Ç!</h3>
        <p>
            –ö–∞–∂–¥–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ —Ç–µ–ø–µ—Ä—å –¥–∞–µ—Ç —Ä–∞–∑–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤ (–æ—Ç 1 –¥–æ 4). –ö–æ–≥–¥–∞ –≤—ã –ø–æ–ø–∞–¥–∞–µ—Ç–µ, –Ω–∞–¥ –∑–≤–µ—Ä–µ–º –ø–æ—è–≤–ª—è–µ—Ç—Å—è **–∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ** —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º —Å—á–µ—Ç–æ–º! –¶–µ–ª—å—Ç–µ—Å—å –≤ —Ä–µ–¥–∫–∏—Ö üê∏ –∏ ü¶â!
        </p>
        
        <p>–£–¥–∞—á–∏ –≤ –æ—Ö–æ—Ç–µ!</p>
        <button id="closeModalButton">–ö–õ–ê–°–°–ù–û!</button>
    </div>
</div>
<!-- –ö–æ–Ω–µ—Ü –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->

<script>
    // --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–≥—Ä—ã ---
    // –î–∞–Ω–Ω—ã–µ –æ –∂–∏–≤–æ—Ç–Ω—ã—Ö, —Ç–µ–ø–µ—Ä—å —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—á–∫–æ–≤ (–æ—Ç 1 –¥–æ 4)
    const ANIMAL_DATA = [
        { emoji: 'üê∞', score: 1 }, // –ó–∞—è—Ü
        { emoji: 'üêª', score: 1 }, // –ú–µ–¥–≤–µ–¥—å
        { emoji: 'üê†', score: 1 }, // –†—ã–±–∞
        
        { emoji: 'ü¶ä', score: 2 }, // –õ–∏—Å–∞
        { emoji: 'üêº', score: 2 }, // –ü–∞–Ω–¥–∞
        { emoji: 'üê≥', score: 2 }, // –ö–∏—Ç

        { emoji: 'ü¶Å', score: 3 }, // –õ–µ–≤
        { emoji: 'ü¶ã', score: 3 }, // –ë–∞–±–æ—á–∫–∞
        { emoji: 'üêí', score: 3 }, // –û–±–µ–∑—å—è–Ω–∞
        
        { emoji: 'üê∏', score: 4 }, // –õ—è–≥—É—à–∫–∞ (—Å–∞–º—ã–π —Ü–µ–Ω–Ω—ã–π)
        { emoji: 'ü¶â', score: 4 }, // –°–æ–≤–∞ (—Å–∞–º—ã–π —Ü–µ–Ω–Ω—ã–π)
        { emoji: 'üêπ', score: 4 }, // –•–æ–º—è–∫ (—Å–∞–º—ã–π —Ü–µ–Ω–Ω—ã–π)
    ];

    const ANIMAL_SIZE = 40; 
    const HITBOX_MULTIPLIER = 2.0; 
    const MAX_SPEED = 4.0; 
    const HIGH_SCORE_KEY = 'animalCatcherHighScore'; 
    const BGM_URL = 'https://files.catbox.moe/cf3amh.mp3'; 
    
    // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ---
    const DIFFICULTY_PRESETS = {
        'relax': {
            name: '–†–µ–ª–∞–∫—Å',
            initialSpeed: 0.3,
            speedIncrement: 0.01,
            spawnIntervalMs: 1500,
        },
        'farm': { // –°–¥–µ–ª–∞–Ω–æ –ª–µ–≥—á–µ
            name: '–§–µ—Ä–º–∞',
            initialSpeed: 0.5, 
            speedIncrement: 0.03, 
            spawnIntervalMs: 1200, 
        },
        'hell': {
            name: '–ê–¥',
            initialSpeed: 1.5,
            speedIncrement: 0.15,
            spawnIntervalMs: 700,
        }
    };

    // --- DOM –≠–ª–µ–º–µ–Ω—Ç—ã ---
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const scoreDisplay = document.getElementById('score');
    const highScoreDisplay = document.getElementById('high-score'); 
    const startButton = document.getElementById('startButton');
    const restartButton = document.getElementById('restartButton');
    const gameOverScreen = document.getElementById('game-over-screen');
    const finalScoreDisplay = document.getElementById('final-score');
    const infoBar = document.getElementById('info-bar');
    const difficultySelectionDiv = document.getElementById('difficulty-selection');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–æ–≤–æ—Å—Ç–µ–π
    const newsButton = document.getElementById('newsButton');
    const newsModal = document.getElementById('news-modal');
    const closeModalButton = document.getElementById('closeModalButton');


    // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã ---
    let gameLoopId;
    let lastTime = 0;
    let score = 0;
    let isGameRunning = false;
    let animals = [];
    let floatingTexts = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –æ—á–∫–æ–≤
    let lastSpawnTime = 0;

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∑–∞–≤–∏—Å—è—â–∏–µ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    let speed = 0;
    let speedIncrement = 0;
    let spawnIntervalMs = 0;
    let selectedDifficulty = 'farm'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é

    // --- –ê—É–¥–∏–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Tone.js ---
    let catchSynth; 
    let missSynth;  
    let bgmPlayer; 
    let audioInitialized = false;

    // --- –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ –õ—É—á—à–∏–π –°—á–µ—Ç ---
    let currentHighScore = 0;
    
    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ª—É—á—à–∏–π —Å—á–µ—Ç –∏–∑ localStorage.
     */
    function loadHighScore() {
        const storedScore = localStorage.getItem(HIGH_SCORE_KEY);
        currentHighScore = parseInt(storedScore) || 0;
        highScoreDisplay.textContent = currentHighScore;
        console.log("High score loaded from localStorage:", currentHighScore);
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–π –ª—É—á—à–∏–π —Å—á–µ—Ç –≤ localStorage, –µ—Å–ª–∏ –æ–Ω –≤—ã—à–µ —Ç–µ–∫—É—â–µ–≥–æ.
     * @param {number} newScore - –¢–µ–∫—É—â–∏–π –Ω–∞–±—Ä–∞–Ω–Ω—ã–π —Å—á–µ—Ç.
     */
    function saveHighScore(newScore) {
        if (newScore > currentHighScore) {
            currentHighScore = newScore;
            localStorage.setItem(HIGH_SCORE_KEY, newScore);
            highScoreDisplay.textContent = currentHighScore;
            console.log(`New high score saved to localStorage: ${newScore}`);
        }
    }


    // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ Canvas –¥–ª—è –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏ ---
    function resizeCanvas() {
        const container = document.getElementById('game-container');
        canvas.width = container.clientWidth - 20; 
        canvas.height = Math.min(window.innerHeight * 0.6, 600); 
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas(); 

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤–∏–¥ –∫–Ω–æ–ø–æ–∫.
     * @param {string} level - –ö–ª—é—á —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ('relax', 'farm', 'hell').
     */
    function selectDifficulty(level) {
        if (!DIFFICULTY_PRESETS[level]) return;

        selectedDifficulty = level;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        document.querySelectorAll('.difficulty-buttons button').forEach(button => {
            button.classList.remove('active');
        });
        document.querySelector(`[data-level="${level}"]`).classList.add('active');
        
        console.log(`Difficulty set to: ${DIFFICULTY_PRESETS[level].name}`);
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É–¥–∏–æ ---
    function initializeAudio() {
        if (audioInitialized) return;
        
        // 1. –ó–≤—É–∫ –ø–æ–∏–º–∫–∏ (–ó–í–£–ö –õ–û–ü–ê–ù–ò–Ø –ü–£–ó–´–†–Ø)
        catchSynth = new Tone.MetalSynth({
            frequency: 4000, 
            envelope: { attack: 0.001, decay: 0.1, release: 0.05 },
            harmonicity: 3.1, modulationIndex: 10, octaves: 1, volume: -10 
        }).toDestination();

        // 2. –ó–≤—É–∫ –ø—Ä–æ–º–∞—Ö–∞
        missSynth = new Tone.Synth({
            oscillator: { type: 'triangle' },
            envelope: { attack: 0.05, decay: 0.1, sustain: 0.0, release: 0.1 },
            volume: -15 
        }).toDestination();
        
        // 3. –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞ (BGM)
        bgmPlayer = new Tone.Player({
            url: BGM_URL,
            loop: true, 
            volume: -18 
        }).toDestination();
        
        bgmPlayer.onerror = (e) => {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ BGM.", e);
        };
        
        audioInitialized = true;
    }

    // --- –ê—É–¥–∏–æ –§—É–Ω–∫—Ü–∏–∏ ---

    function playCatchSound() {
        if (audioInitialized) {
            catchSynth.triggerAttackRelease('8n');
        }
    }
    
    function playMissSound() {
        if (audioInitialized) {
            missSynth.triggerAttackRelease('A3', '16n');
        }
    }

    // --- –ö–ª–∞—Å—Å –ñ–∏–≤–æ—Ç–Ω–æ–≥–æ –∏ –õ–æ–≥–∏–∫–∞ –ò–≥—Ä—ã ---

    class Animal {
        /**
         * @param {number} x - X-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
         * @param {number} y - Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
         * @param {object} data - –û–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ ({emoji, score})
         * @param {number} dy - –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ Y
         */
        constructor(x, y, data, dy) {
            this.x = x;
            this.y = y;
            this.emoji = data.emoji;
            this.scoreValue = data.score; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤
            this.dy = dy; 
            this.radius = ANIMAL_SIZE / 2;
            this.hitRadius = (ANIMAL_SIZE / 2) * HITBOX_MULTIPLIER;
        }

        draw() {
            ctx.font = `${ANIMAL_SIZE}px Fredoka`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(this.emoji, this.x, this.y);
        }

        update(deltaTime) {
            this.y += this.dy * deltaTime / 16; 
        }
    }
    
    // --- –ö–ª–∞—Å—Å –í—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –¢–µ–∫—Å—Ç–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –æ—á–∫–æ–≤ ---
    class FloatingText {
        constructor(x, y, text) {
            this.x = x;
            this.y = y;
            this.text = text;
            this.lifetime = 60; // –ñ–∏–∑–Ω—å –≤ –∫–∞–¥—Ä–∞—Ö (–ø—Ä–∏–º–µ—Ä–Ω–æ 1 —Å–µ–∫—É–Ω–¥–∞)
            this.fade = 1.0;
            this.dy = -1.5; // –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–¥—ä–µ–º–∞
        }

        update() {
            this.y += this.dy;
            this.lifetime--;
            this.fade = Math.max(0, this.lifetime / 60); // –ü–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ
        }

        draw() {
            if (this.lifetime <= 0) return;

            ctx.globalAlpha = this.fade;
            ctx.font = '700 24px Fredoka';
            
            // –¶–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—á–∫–æ–≤
            const points = parseInt(this.text.substring(1)); 
            if (points === 4) {
                ctx.fillStyle = '#c62828'; // –ö—Ä–∞—Å–Ω—ã–π (MAX Score)
            } else if (points === 3) {
                ctx.fillStyle = '#ff8f00'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
            } else {
                ctx.fillStyle = '#388e3c'; // –ó–µ–ª–µ–Ω—ã–π
            }
            
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(this.text, this.x, this.y);
            ctx.globalAlpha = 1.0; // –°–±—Ä–æ—Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
        }
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.
     */
    function createFloatingText(x, y, text) {
        floatingTexts.push(new FloatingText(x, y, text));
    }


    function spawnAnimal() {
        const data = ANIMAL_DATA[Math.floor(Math.random() * ANIMAL_DATA.length)];
        const x = ANIMAL_SIZE + Math.random() * (canvas.width - ANIMAL_SIZE * 2);
        const y = -ANIMAL_SIZE;
        const dy = speed * 10;
        
        animals.push(new Animal(x, y, data, dy));
    }

    function checkCollision(touchX, touchY, animal) {
        const dx = touchX - animal.x;
        const dy = touchY - animal.y;
        const distanceSquared = dx * dx + dy * dy;
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π hitRadius –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ø–∞–¥–∞–Ω–∏—è
        return distanceSquared < (animal.hitRadius * animal.hitRadius);
    }

    function handleInput(clientX, clientY) {
        if (!isGameRunning) return;

        const rect = canvas.getBoundingClientRect();
        const touchX = clientX - rect.left;
        const touchY = clientY - rect.top;
        
        for (let i = animals.length - 1; i >= 0; i--) {
            const animal = animals[i];
            if (checkCollision(touchX, touchY, animal)) {
                // –ü–æ–π–º–∞–Ω–æ!
                const points = animal.scoreValue; // –ü–æ–ª—É—á–∞–µ–º –æ—á–∫–∏ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ
                animals.splice(i, 1);
                
                score += points; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±—â–∏–π —Å—á–µ—Ç
                scoreDisplay.textContent = score;
                
                playCatchSound(); 
                
                // –°–æ–∑–¥–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–∏–π —Ç–µ–∫—Å—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—á–∫–æ–≤
                createFloatingText(animal.x, animal.y, `+${points}`); 

                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
                speed = Math.min(MAX_SPEED, speed + speedIncrement);
                return; 
            }
        }
    }

    function updateGame(deltaTime) {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω—ã—Ö
        for (let i = animals.length - 1; i >= 0; i--) {
            const animal = animals[i];
            animal.update(deltaTime);

            if (animal.y > canvas.height + ANIMAL_SIZE / 2) {
                animals.splice(i, 1);
                playMissSound(); 
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞
        for (let i = floatingTexts.length - 1; i >= 0; i--) {
            const text = floatingTexts[i];
            text.update();
            if (text.lifetime <= 0) {
                floatingTexts.splice(i, 1);
            }
        }
        
        const currentTime = Date.now();
        // –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–ø–∞–≤–Ω–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∏ —Ç–µ–∫—É—â–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
        if (currentTime - lastSpawnTime > spawnIntervalMs * (1 / speed)) { 
            spawnAnimal();
            lastSpawnTime = currentTime;
        }
    }

    function drawGame() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        animals.forEach(animal => animal.draw());
        
        // –†–∏—Å—É–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–∏–π —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∂–∏–≤–æ—Ç–Ω—ã—Ö
        floatingTexts.forEach(text => text.draw()); 

        // –†–∏—Å—É–µ–º –∫—Ä–∞—Å–Ω—É—é –ª–∏–Ω–∏—é –ø—Ä–æ–∏–≥—Ä—ã—à–∞
        ctx.strokeStyle = '#d32f2f';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(0, canvas.height);
        ctx.lineTo(canvas.width, canvas.height);
        ctx.stroke();
    }

    function gameLoop(timestamp) {
        if (!isGameRunning) return;

        const deltaTime = timestamp - lastTime;
        lastTime = timestamp;

        updateGame(deltaTime);
        drawGame();

        gameLoopId = requestAnimationFrame(gameLoop);
    }

    function showFinalScore() {
        isGameRunning = false;
        cancelAnimationFrame(gameLoopId);
        
        saveHighScore(score);
        
        if (bgmPlayer && bgmPlayer.state === 'started') {
             bgmPlayer.stop();
        }
        
        finalScoreDisplay.textContent = score;
        gameOverScreen.style.display = 'flex';
        infoBar.style.display = 'none';
        startButton.style.display = 'none';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
        difficultySelectionDiv.style.display = 'flex';
    }

    async function startGame() {
        if (isGameRunning) {
            // –ï—Å–ª–∏ –∏–≥—Ä–∞ —É–∂–µ –∏–¥–µ—Ç, —Ç–æ —ç—Ç–æ –°–ë–†–û–°
            showFinalScore();
            return;
        }
        
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ AudioContext
        if (!audioInitialized) {
            initializeAudio();
            
            const originalText = startButton.textContent;
            startButton.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –º—É–∑—ã–∫–∏...'; 
            startButton.disabled = true;

            try {
                await Tone.start();
                await Tone.loaded(); 
            } catch(e) {
                console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞—É–¥–∏–æ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∏ BGM. –ò–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∞ –±–µ–∑ –∑–≤—É–∫–æ–≤/–º—É–∑—ã–∫–∏.", e);
            } finally {
                startButton.textContent = originalText;
                startButton.disabled = false;
            }
        }

        // 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        const preset = DIFFICULTY_PRESETS[selectedDifficulty];
        speed = preset.initialSpeed;
        speedIncrement = preset.speedIncrement;
        spawnIntervalMs = preset.spawnIntervalMs;
        
        // 3. –ó–∞–ø—É—Å–∫ BGM
        if (bgmPlayer && bgmPlayer.buffer && bgmPlayer.buffer.loaded && bgmPlayer.state !== 'started') {
            bgmPlayer.start();
        }

        // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
        score = 0;
        animals = [];
        floatingTexts = []; // –û—á–∏—â–∞–µ–º –º–∞—Å—Å–∏–≤ –∞–Ω–∏–º–∞—Ü–∏–π –æ—á–∫–æ–≤
        lastTime = 0;
        lastSpawnTime = 0;
        isGameRunning = true;

        scoreDisplay.textContent = score;
        gameOverScreen.style.display = 'none';
        
        startButton.textContent = '–°–ë–†–û–°–ò–¢–¨ –ò–ì–†–£'; 
        startButton.style.backgroundColor = '#d32f2f';
        startButton.style.boxShadow = '0 6px #b71c1c';
        
        difficultySelectionDiv.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã
        infoBar.style.display = 'flex';

        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∏–≥—Ä—ã
        gameLoopId = requestAnimationFrame(gameLoop);
    }

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
    function canvasTouchHandler(e) {
        e.preventDefault(); 
        const touch = e.touches ? e.touches[0] : e;
        handleInput(touch.clientX, touch.clientY);
    }

    canvas.addEventListener('click', canvasTouchHandler);
    canvas.addEventListener('touchstart', canvasTouchHandler);
    startButton.addEventListener('click', startGame);
    
    restartButton.addEventListener('click', () => {
        startButton.textContent = '–ù–ê–ß–ê–¢–¨ –ò–ì–†–£';
        startButton.style.backgroundColor = ''; // –°–±—Ä–æ—Å —Ñ–æ–Ω–∞, —á—Ç–æ–±—ã –≥—Ä–∞–¥–∏–µ–Ω—Ç –ø—Ä–∏–º–µ–Ω–∏–ª—Å—è –∏–∑ CSS
        startButton.style.boxShadow = ''; // –°–±—Ä–æ—Å —Ç–µ–Ω–∏, —á—Ç–æ–±—ã –≥—Ä–∞–¥–∏–µ–Ω—Ç –ø—Ä–∏–º–µ–Ω–∏–ª—Å—è –∏–∑ CSS
        startButton.style.display = 'block';
        gameOverScreen.style.display = 'none';
        selectDifficulty(selectedDifficulty); // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–π –≤–∏–¥
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    document.querySelectorAll('.difficulty-buttons button').forEach(button => {
        button.addEventListener('click', (e) => {
            selectDifficulty(e.target.dataset.level);
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
    newsButton.addEventListener('click', () => {
        newsModal.style.display = 'flex';
    });

    closeModalButton.addEventListener('click', () => {
        newsModal.style.display = 'none';
    });

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –ª—É—á—à–µ–≥–æ —Å—á–µ—Ç–∞
    document.addEventListener('DOMContentLoaded', () => {
        gameOverScreen.style.display = 'none';
        infoBar.style.display = 'none';
        loadHighScore(); 
        selectDifficulty('farm'); // –í—ã–±–∏—Ä–∞–µ–º "–§–µ—Ä–º–∞" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    });

</script>

</body>
</html>
